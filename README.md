# üå¶Ô∏è X-WindyBot - Capturador Autom√°tico de Radar Meteorol√≥gico

Una herramienta de automatizaci√≥n que utiliza GitHub Actions para capturar screenshots del radar meteorol√≥gico de Windy.com y publicarlos autom√°ticamente en Twitter/X.

## üöÄ Caracter√≠sticas

- ‚è∞ **Captura autom√°tica cada 5-10 minutos** mediante GitHub Actions (cron + disparo manual)
- üé≠ **Motor Playwright** con soporte nativo para WebGL y renderizado de canvas
- üé® **Capturas de alta calidad** (50-800 KB) con preserveDrawingBuffer y canvas.toDataURL()
- üê¶ **Publicaci√≥n autom√°tica en Twitter/X** con imagen adjunta y coordenadas
- üìç **Coordenadas configurables** mediante Variables de Repositorio
- üñ•Ô∏è **Aplicaci√≥n local en Express** para disparar capturas desde `localhost` con un clic
- üìÅ **Almacenamiento autom√°tico** en `captures/` con limpieza de hist√≥ricos (√∫ltimas 100 capturas)
- üîÑ **Auto-commit & push** de capturas versionadas en el repositorio
- üöÄ **Instalaci√≥n simplificada** sin necesidad de drivers externos ni configuraciones complejas
- üìä **Logging detallado** (tiempos, estados de canvas, validaciones) para depuraci√≥n r√°pida

## üìÇ Estructura del Proyecto

```
X-WindyBot/
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ capture-ultra-fast.yml   # Workflow con Playwright + Twitter
‚îú‚îÄ‚îÄ server/
‚îÇ   ‚îî‚îÄ‚îÄ local-server.js              # Servidor Express para el modo localhost
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ capture-playwright.js        # Motor Playwright con soporte WebGL
‚îÇ   ‚îú‚îÄ‚îÄ publish-to-twitter.js        # Publicaci√≥n autom√°tica en Twitter/X
‚îÇ   ‚îî‚îÄ‚îÄ capture-selenium.js          # Motor Selenium (legacy, backup)
‚îú‚îÄ‚îÄ captures/                        # Carpeta donde se guardan las capturas
‚îÇ   ‚îî‚îÄ‚îÄ .gitkeep                     # Mantiene la carpeta en Git
‚îú‚îÄ‚îÄ package.json                     # Dependencias y scripts de NPM
‚îú‚îÄ‚îÄ TWITTER_SETUP.md                 # Gu√≠a de configuraci√≥n de Twitter API
‚îú‚îÄ‚îÄ CONFIGURACION.md                 # Gu√≠a de coordenadas y personalizaci√≥n
‚îî‚îÄ‚îÄ README.md                        # Esta documentaci√≥n
```

## ‚öôÔ∏è Configuraci√≥n

### 1. Requisitos Previos

- Repositorio de GitHub
- Permisos de escritura en el repositorio (para commits autom√°ticos)
- Node.js 18+ instalado localmente (para pruebas locales)

### 2. Instalaci√≥n y pruebas locales

```bash
# Clonar el repositorio
git clone https://github.com/jmtdev0/X-WindyBot.git
cd X-WindyBot

# Instalar dependencias Node.js
npm install

# Instalar navegador Playwright Chromium
npx playwright install chromium

# Ejecutar una captura (mismo c√≥digo que GitHub Actions)
npm run capture

# Levantar la aplicaci√≥n local en http://localhost:3000 (bot√≥n ¬´Tomar captura¬ª)
npm run start:local
```

> ‚ÑπÔ∏è Playwright instala su propia versi√≥n de Chromium autom√°ticamente. No necesitas instalar Chrome ni drivers externos.

## üè† Modo servidor local (Express + Playwright)

El comando `npm run start:local` levanta una micro-aplicaci√≥n en Express que reutiliza exactamente el mismo motor Playwright que GitHub Actions. √ösala para depurar o generar capturas on-demand desde tu m√°quina:

1. Ejecuta `npm run start:local`
2. Abre `http://localhost:3000`
3. Pulsa **¬´üì∏ Tomar captura ahora¬ª**
4. Revisa el panel de resultados y la previsualizaci√≥n. Las im√°genes se guardan en la carpeta configurada (por defecto `captures/`).

### Variables de entorno √∫tiles

| Variable | Valor por defecto | Descripci√≥n |
| --- | --- | --- |
| `PORT` | `3000` | Puerto donde escucha la app local. |
| `LOCAL_CAPTURES_DIR` | `./captures` | Carpeta donde se persisten las capturas al usar el modo local. |
| `WINDY_URL` | `https://www.windy.com/?radar,39.853,-3.807,7` | URL objetivo que abrir√° Selenium (aplica tanto en local como en CI si exportas la variable). |
| `WINDOW_WIDTH` / `WINDOW_HEIGHT` | `1920` / `1080` | Resoluci√≥n de la ventana virtual para la captura. |
| `WINDY_TIMEOUT_MS` | `45000` | Timeout global (carga de p√°gina / scripts) en milisegundos. |
| `WINDY_WAIT_MS` | `15000` | Tiempo adicional en milisegundos para asegurarse de que el radar renderice por completo. |

> üìù La API REST local devuelve el resultado en JSON (`/capture`) y expone un endpoint de estado (`/status`). Las capturas se sirven como archivos est√°ticos en `/captures/<archivo>.png`.

### 3. Configuraci√≥n de GitHub Actions

El workflow est√° configurado para ejecutarse autom√°ticamente. No necesitas configuraci√≥n adicional, pero puedes personalizar:

#### Configurar coordenadas del radar (Variables de Repositorio)

Las coordenadas del radar se configuran mediante **Variables de Repositorio** en GitHub:

1. Ve a tu repositorio en GitHub
2. Haz clic en **Settings** ‚Üí **Secrets and variables** ‚Üí **Actions** ‚Üí Pesta√±a **Variables**
3. A√±ade las siguientes variables (opcionales):
   - `RADAR_LAT`: Latitud (por defecto: `39.418`)
   - `RADAR_LON`: Longitud (por defecto: `-5.160`)
   - `RADAR_ZOOM`: Nivel de zoom (por defecto: `6`)

**Ejemplo de coordenadas:**
- Madrid: Lat `40.416`, Lon `-3.703`, Zoom `7`
- Barcelona: Lat `41.385`, Lon `2.173`, Zoom `7`
- Valencia: Lat `39.470`, Lon `-0.377`, Zoom `7`
- Sevilla: Lat `37.389`, Lon `-5.984`, Zoom `7`

Si no configuras estas variables, el workflow usar√° las coordenadas por defecto de Extremadura.

#### Cambiar coordenadas localmente

Para pruebas locales, puedes usar variables de entorno:

```bash
# Windows PowerShell
$env:RADAR_LAT="40.416"; $env:RADAR_LON="-3.703"; $env:RADAR_ZOOM="7"; npm run capture

# Linux/Mac
RADAR_LAT=40.416 RADAR_LON=-3.703 RADAR_ZOOM=7 npm run capture
```

#### Cambiar la frecuencia de captura

Edita el archivo `.github/workflows/capture-ultra-fast.yml` y modifica el cron schedule:

```yaml
schedule:
  # Cada 5 minutos (actual)
  - cron: '*/5 * * * *'
  
  # Ejemplos alternativos:
  # - cron: '0 * * * *'     # Cada hora
  # - cron: '0 */2 * * *'   # Cada 2 horas
  # - cron: '0 8-20 * * *'  # Cada hora de 8 AM a 8 PM
```

## üéØ Uso

### Ejecuci√≥n Autom√°tica

El bot se ejecuta autom√°ticamente cada 5 minutos sin necesidad de intervenci√≥n. Puedes ver las ejecuciones en:

1. Ve a tu repositorio en GitHub
2. Haz clic en la pesta√±a **Actions**
3. Selecciona el workflow **"üì∏ Captura Radar Meteorol√≥gico"**

### Ejecuci√≥n Manual

Para ejecutar manualmente una captura:

1. Ve a **Actions** ‚Üí **"üì∏ Captura Radar Meteorol√≥gico"**
2. Haz clic en **"Run workflow"**
3. Opcionalmente marca **"Limpiar archivos antiguos"** para una limpieza manual adicional (la limpieza autom√°tica ya mantiene 100 capturas)

### Ver Capturas

Las capturas se almacenan en la carpeta `captures/` con el formato:
```
radar_YYYY-MM-DD_HH-MM-SS.png
```

Ejemplo: `radar_2025-09-28_14-30-25.png`

## ÔøΩ Publicaci√≥n Autom√°tica en Twitter/X

X-WindyBot puede publicar autom√°ticamente las capturas del radar en Twitter/X. 

### Configurar Twitter (Opcional)

Si quieres habilitar la publicaci√≥n en Twitter:

1. **Sigue la gu√≠a completa**: Lee [`TWITTER_SETUP.md`](TWITTER_SETUP.md) con instrucciones paso a paso
2. **Obt√©n credenciales**: Crea una app en [Twitter Developer Portal](https://developer.twitter.com/en/portal/dashboard)
3. **Configura Secrets** en GitHub:
   - `TWITTER_API_KEY`
   - `TWITTER_API_SECRET`
   - `TWITTER_ACCESS_TOKEN`
   - `TWITTER_ACCESS_SECRET`

Una vez configurado, cada captura se publicar√° autom√°ticamente con un tweet como:

```
üåßÔ∏è Radar meteorol√≥gico actualizado

üìÖ 07/10/2025 - 14:30
üìç Lat 39.418, Lon -5.160

üîó Ver en vivo: https://www.windy.com/?radar,39.418,-5.160,6

#Meteorolog√≠a #Radar #Tiempo
```

### Personalizar el Mensaje del Tweet

Puedes personalizar el mensaje configurando la Variable de Repositorio:

- `TWITTER_CUSTOM_MESSAGE`: Tu mensaje personalizado
- `TWITTER_INCLUDE_LINK`: `true` o `false` (incluir enlace a Windy)

### Probar Publicaci√≥n Localmente

```bash
# Windows PowerShell
$env:TWITTER_API_KEY="tu_key"; $env:TWITTER_API_SECRET="tu_secret"
$env:TWITTER_ACCESS_TOKEN="tu_token"; $env:TWITTER_ACCESS_SECRET="tu_secret"
npm run publish:twitter
```

**Nota:** Si no configuras los secrets de Twitter, el workflow funcionar√° normalmente pero saltar√° la publicaci√≥n.

## ÔøΩüîß Personalizaci√≥n Avanzada

### Modificar Configuraciones de Captura

En `scripts/capture-playwright.js` puedes personalizar:

```javascript
const CONFIG = {
    // URL espec√≠fica del radar
    url: 'https://www.windy.com/?radar,39.853,-3.807,7',

    // Resoluci√≥n del viewport de Chromium
    viewport: {
        width: 1920,
        height: 1080
    },

    // Timeout global y espera espec√≠fica para el radar (ms)
    timeout: 60000,
    waitForRadar: 30000
};
```

### Gesti√≥n de Archivos Antiguos

El sistema incluye limpieza autom√°tica de capturas antiguas:

```javascript
// Mantener solo los √∫ltimos 100 archivos (configuraci√≥n por defecto)
await cleanOldCaptures(100);
```

**‚ÑπÔ∏è Configuraci√≥n actual**: El bot mantiene autom√°ticamente solo las **√∫ltimas 100 capturas** despu√©s de cada ejecuci√≥n exitosa.

## üìä Monitoreo y Logs

### Ver Estado de Ejecuciones

En la pesta√±a **Actions** de GitHub puedes:
- Ver el historial completo de ejecuciones
- Verificar logs detallados de cada captura
- Monitorear errores o fallos

### Logs T√≠picos

```
üöÄ Iniciando captura del radar meteorol√≥gico...
üì± Iniciando navegador...
üåê Navegando a Windy.com...
‚è≥ Esperando a que la p√°gina cargue completamente...
üì∏ Capturando screenshot...
‚úÖ Screenshot guardado exitosamente: radar_2025-09-28_14-30-25.png
üìä Tama√±o del archivo: 245 KB
üéâ ¬°Captura completada exitosamente!
```

## üõ†Ô∏è Soluci√≥n de Problemas

### Capturas vac√≠as o peque√±as (< 10 KB)

**S√≠ntomas**:
- Las capturas se generan pero est√°n vac√≠as o muestran contenido incompleto
- Archivos PNG de ~8 KB en lugar de 650-800 KB esperados
- El radar no se visualiza en la captura

**Causa**: Problemas con el renderizado de WebGL o tiempo insuficiente de carga

**Soluci√≥n**:
1. **‚úÖ Ya est√° corregido con Playwright** - Usa `preserveDrawingBuffer` y `canvas.toDataURL()`
2. **üîß Aumenta el tiempo de espera** - Modifica `waitForRadar` en `CONFIG` (por defecto 30s)
3. **üîç Verifica los logs** - Revisa que `preserveDrawingBuffer: true` aparezca en la consola
4. **ÔøΩ Reporta si persiste** - Con capturas de menos de 100 KB hay un problema

### Error de instalaci√≥n de Playwright

**S√≠ntomas**: 
- Falla `npx playwright install chromium`
- Error: "browserType.launch: Executable doesn't exist"

**Soluci√≥n**: 
1. **Ejecuta con --with-deps**: `npx playwright install chromium --with-deps`
2. **Verifica permisos** de escritura en la carpeta del proyecto
3. **Limpia cache** de Playwright: `npx playwright uninstall --all` y reinstala

### El workflow no se ejecuta autom√°ticamente

1. **Verifica que el repositorio sea p√∫blico** o que tengas GitHub Pro/Team
2. **Comprueba los permisos** en Settings ‚Üí Actions ‚Üí General
3. **Revisa si hay errores** en la pesta√±a Actions

### Capturas en blanco o errores de carga

1. **Aumenta `waitForRadar`** en `scripts/capture-playwright.js` (por defecto 30s)
2. **Verifica la URL** de Windy.com en el CONFIG
3. **Revisa los logs** para errores espec√≠ficos de Playwright
4. **Verifica estado del canvas** en los logs (debe mostrar `preserveDrawingBuffer: true`)

### El repositorio crece mucho

1. **La limpieza autom√°tica ya est√° activada** (mantiene 100 capturas)
2. **Ejecuta limpieza manual adicional** con la opci√≥n en "Run workflow"
3. **Reduce el l√≠mite de limpieza autom√°tica** editando el valor en `scripts/capture-native.sh`
4. **Reduce la frecuencia** de capturas modificando el cron schedule

### Falta de espacio en GitHub

GitHub ofrece 1GB gratis. Con capturas de ~250KB y m√°ximo 100 archivos:
- **M√°ximo espacio usado**: 100 capturas √ó 250KB = ~25MB
- **Tiempo cubierto**: ~8.3 horas de historial continuo

**‚úÖ Soluci√≥n implementada**: La limpieza autom√°tica mantiene siempre solo las √∫ltimas 100 capturas.

## ü§ù Contribuciones

¬°Las contribuciones son bienvenidas! Algunas ideas:

- üåç Soporte para m√∫ltiples ubicaciones
- üê¶ Integraci√≥n con Twitter/X para publicaci√≥n autom√°tica  
- üì± Notificaciones cuando se detecten condiciones meteorol√≥gicas espec√≠ficas
- üìà Generaci√≥n de GIFs animados con secuencias de capturas
- üîç An√°lisis autom√°tico de patrones meteorol√≥gicos
- üìÖ Configuraci√≥n de retenci√≥n de capturas por d√≠as/horas en lugar de cantidad fija

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT. Ver el archivo `LICENSE` para m√°s detalles.

## üôè Cr√©ditos

- **[Windy.com](https://www.windy.com)** - Fuente de datos meteorol√≥gicos
- **[Playwright](https://playwright.dev/)** - Automatizaci√≥n de navegador con soporte WebGL
- **[GitHub Actions](https://github.com/features/actions)** - Plataforma de CI/CD

---

## üìû Soporte

Si encuentras alg√∫n problema o tienes sugerencias:

1. üêõ **Reporta bugs** en [Issues](https://github.com/jmtdev0/X-WindyBot/issues)
2. üí° **Sugiere mejoras** en [Discussions](https://github.com/jmtdev0/X-WindyBot/discussions)
3. ‚≠ê **¬°Dale una estrella** si te resulta √∫til!

---

<div align="center">

**üå¶Ô∏è Mantente al d√≠a con el clima con X-WindyBot ü§ñ**

[üöÄ Ver Actions](../../actions) | [üìÅ Ver Capturas](./captures) | [üêõ Reportar Bug](../../issues)

</div>