name: Captura Radar con Playwright

on:
  # Ejecucion automatica temporalmente desactivada para testing
  # schedule:
  #   - cron: '*/5 * * * *'
  
  # Permite ejecucion manual desde la interfaz de GitHub
  workflow_dispatch:
    inputs:
      cleanup_old_files:
        description: 'Limpiar archivos antiguos (mantener ultimos 100)'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  capture-radar-playwright:
    name: Captura Radar (Playwright + WebGL)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    outputs:
      file_count: ${{ steps.check.outputs.file_count }}
      has_changes: ${{ steps.check.outputs.has_changes }}

    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependencias Node.js
        run: npm install

      - name: Instalar Playwright Chromium
        run: npx playwright install chromium --with-deps

      - name: Crear directorio de capturas
        run: mkdir -p captures

      - name: Ejecutar captura con Playwright
        timeout-minutes: 2
        env:
          RADAR_LAT: ${{ vars.RADAR_LAT }}
          RADAR_LON: ${{ vars.RADAR_LON }}
          RADAR_ZOOM: ${{ vars.RADAR_ZOOM }}
        run: |
          echo "ðŸš€ Iniciando captura con Playwright (soporte WebGL nativo)..."
          echo "ðŸŽ¯ MÃ©todo: Chromium + preserveDrawingBuffer + canvas.toDataURL()"
          
          # Usar valores por defecto si las variables no estÃ¡n definidas
          RADAR_LAT=${RADAR_LAT:-39.418}
          RADAR_LON=${RADAR_LON:--5.160}
          RADAR_ZOOM=${RADAR_ZOOM:-6}
          
          echo "ðŸ“ Coordenadas: Lat $RADAR_LAT, Lon $RADAR_LON, Zoom $RADAR_ZOOM"
          echo "=" | tr '\n' '=' | head -c 60; echo
          
          # Exportar para que el script Node.js las lea
          export RADAR_LAT RADAR_LON RADAR_ZOOM
          
          npm run capture
          
          echo ""
          echo "Resultados:"
          ls -lh captures/*.png 2>/dev/null || echo "âš ï¸ No se encontraron capturas PNG"

      - name: Verificar capturas generadas
        id: check
        run: |
          echo "Verificando capturas generadas..."
          
          FILE_COUNT=$(find captures -name "radar_*.png" 2>/dev/null | wc -l)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Total de capturas en el repositorio: $FILE_COUNT"
          
          # Verificar si hay una captura nueva
          LATEST_CAPTURE=$(ls -t captures/radar_*.png 2>/dev/null | head -1)
          if [ -n "$LATEST_CAPTURE" ]; then
            CAPTURE_SIZE=$(stat -f%z "$LATEST_CAPTURE" 2>/dev/null || stat -c%s "$LATEST_CAPTURE" 2>/dev/null || echo "0")
            CAPTURE_SIZE_KB=$((CAPTURE_SIZE / 1024))
            echo "capture_valid=true" >> $GITHUB_OUTPUT
            echo "âœ… Ãšltima captura: $(basename "$LATEST_CAPTURE") (${CAPTURE_SIZE_KB} KB)"
          else
            echo "capture_valid=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No se encontrÃ³ captura reciente"
          fi
          
          echo ""
          echo "ðŸ“ Capturas recientes:"
          ls -lht captures/*.png 2>/dev/null | head -5 || echo "Sin archivos"

      - name: Publicar en Twitter/X
        if: steps.check.outputs.capture_valid == 'true'
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          RADAR_LAT: ${{ vars.RADAR_LAT }}
          RADAR_LON: ${{ vars.RADAR_LON }}
          RADAR_ZOOM: ${{ vars.RADAR_ZOOM }}
          TWITTER_INCLUDE_LINK: ${{ vars.TWITTER_INCLUDE_LINK || 'true' }}
          TWITTER_CUSTOM_MESSAGE: ${{ vars.TWITTER_CUSTOM_MESSAGE }}
        run: |
          # Usar valores por defecto si no estÃ¡n definidas
          export RADAR_LAT=${RADAR_LAT:-39.418}
          export RADAR_LON=${RADAR_LON:--5.160}
          export RADAR_ZOOM=${RADAR_ZOOM:-6}
          
          echo "ðŸ¦ Publicando captura en Twitter/X..."
          
          # Solo publicar si las credenciales estÃ¡n configuradas
          if [ -z "$TWITTER_API_KEY" ]; then
            echo "â­ï¸ Credenciales de Twitter no configuradas, saltando publicaciÃ³n"
            echo "â„¹ï¸ Para habilitar, configura los secrets: TWITTER_API_KEY, TWITTER_API_SECRET, TWITTER_ACCESS_TOKEN, TWITTER_ACCESS_SECRET"
          else
            npm run publish:twitter
          fi

      - name: Limpieza automatica de archivos antiguos
        run: |
          cd captures
          FILE_COUNT=$(find . -name "radar_*.png" 2>/dev/null | wc -l)
          
          if [ "$FILE_COUNT" -gt 100 ]; then
            echo "ðŸ—‘ï¸ Eliminando archivos antiguos (manteniendo ultimos 100)..."
            find . -name "radar_*.png" -printf '%T@ %p\n' | sort -n | head -n -100 | cut -d' ' -f2- | xargs rm -f
            NEW_COUNT=$(find . -name "radar_*.png" | wc -l)
            echo "âœ… Limpieza completada. Archivos restantes: $NEW_COUNT"
          else
            echo "âœ… No necesita limpieza (solo $FILE_COUNT archivos)"
          fi

      - name: Commit y push de capturas
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action - Playwright WebGL"
          
          # AÃ±adir todas las capturas (nuevas y eliminadas)
          git add captures/
          
          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No hay cambios para commitear"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            FINAL_COUNT=$(find captures -name "radar_*.png" | wc -l)
            
            git commit -m "ðŸ“¸ Captura radar Playwright - $TIMESTAMP (Total: $FINAL_COUNT capturas)"
            git push
            
            echo "âœ… Cambios commiteados y pusheados exitosamente"
          fi

      - name: Resumen de ejecucion
        run: |
          echo "=== RESUMEN CAPTURA PLAYWRIGHT ==="
          echo "ðŸ• Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ðŸŽ¯ Trigger: workflow_dispatch"
          echo "ðŸš€ Motor: Playwright Chromium + WebGL"
          echo "âœ… Estado: Captura completada"
          echo "ðŸ“Š Total de capturas en repo: ${{ steps.check.outputs.file_count }}"
          
          echo ""
          echo "ðŸ“ Ãšltima captura:"
          ls -lht captures/radar_*.png 2>/dev/null | head -1 || echo "Sin archivos"
          
          echo ""
          echo "ðŸ“Š TamaÃ±o total de capturas:"
          du -sh captures/ || echo "0B"
          
          echo ""
          echo "ðŸŽ‰ VENTAJAS DE PLAYWRIGHT:"
          echo "  âœ… Soporte WebGL nativo en modo headless"
          echo "  âœ… Capturas de canvas con preserveDrawingBuffer"
          echo "  âœ… MÃ©todo canvas.toDataURL() directo con flush/finish"
          echo "  âœ… SwiftShader para renderizado por software"
          echo "  âœ… Capturas de alta calidad (50-800 KB)"
          echo "  âœ… Sin necesidad de drivers externos"
          echo "  âœ… InstalaciÃ³n simplificada y mÃ¡s rÃ¡pida"
          echo "  âœ… Commits automÃ¡ticos al repositorio"


