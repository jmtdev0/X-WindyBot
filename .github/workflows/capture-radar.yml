name: üì∏ Captura Radar Meteorol√≥gico

# Configuraci√≥n de triggers
on:
  # Ejecuci√≥n autom√°tica cada 5 minutos
  schedule:
    - cron: '*/5 * * * *'
  
  # Permite ejecuci√≥n manual desde la interfaz de GitHub
  workflow_dispatch:
    inputs:
      cleanup_old_files:
        description: 'Limpiar archivos antiguos (mantener √∫ltimos 100)'
        required: false
        default: 'true'
        type: boolean

# Configuraci√≥n de permisos
permissions:
  contents: write
  actions: read

jobs:
  capture-radar:
    name: üå¶Ô∏è Capturar Radar de Windy.com
    runs-on: ubuntu-latest
    
    # Timeout para evitar ejecuciones colgadas
    timeout-minutes: 10
    
    steps:
      # 1. Checkout del repositorio
      - name: üì• Checkout repositorio
        uses: actions/checkout@v4
        with:
          # Traer todo el historial para commits
          fetch-depth: 0
          # Token para poder hacer push
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Configurar Node.js
      - name: üü¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3. Instalar dependencias
      - name: üì¶ Instalar dependencias
        run: npm ci

      # 4. Verificar estructura de directorios
      - name: üìÅ Verificar directorios
        run: |
          mkdir -p captures
          ls -la captures/ || true
          echo "Estructura del proyecto:"
          find . -type f -name "*.js" -o -name "*.json" | head -10

      # 5. Ejecutar script de captura
      - name: üì∏ Ejecutar captura de radar
        run: |
          echo "üöÄ Iniciando captura del radar meteorol√≥gico..."
          npm run screenshot
        env:
          # Variables de entorno para Puppeteer en CI
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: false
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable

      # 6. Verificar si hay nuevos archivos
      - name: üîç Verificar cambios
        id: verify-changes
        run: |
          # Verificar si hay archivos nuevos o modificados
          if git diff --quiet && git diff --staged --quiet; then
            echo "No hay cambios para commitear"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Se detectaron cambios"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Mostrar estad√≠sticas
            echo "üìä Archivos modificados:"
            git status --porcelain
            
            echo "üìà Estad√≠sticas de la carpeta captures:"
            ls -la captures/ | tail -5
            
            # Contar archivos en captures
            FILE_COUNT=$(find captures -name "*.png" | wc -l)
            echo "Total de capturas: $FILE_COUNT"
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          fi

      # 7. Configurar Git (solo si hay cambios)
      - name: ‚öôÔ∏è Configurar Git
        if: steps.verify-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action - Radar Capture"
          git config --local core.autocrlf false

      # 8. Limpieza autom√°tica despu√©s de captura exitosa
      - name: üßπ Limpieza autom√°tica de capturas antiguas
        if: steps.verify-changes.outputs.has_changes == 'true'
        run: |
          cd captures
          FILE_COUNT=$(find . -name "radar_*.png" | wc -l)
          echo "üìä Archivos actuales antes de limpieza: $FILE_COUNT"
          
          if [ "$FILE_COUNT" -gt 100 ]; then
            echo "üßπ Eliminando archivos antiguos (manteniendo √∫ltimos 100)..."
            find . -name "radar_*.png" -printf '%T@ %p\n' | sort -n | head -n -100 | cut -d' ' -f2- | xargs rm -f
            NEW_COUNT=$(find . -name "radar_*.png" | wc -l)
            echo "‚úÖ Limpieza autom√°tica completada. Archivos restantes: $NEW_COUNT"
          else
            echo "‚ÑπÔ∏è  No es necesario limpiar (solo $FILE_COUNT archivos)"
          fi

      # 9. Commit y push (solo si hay cambios)
      - name: üíæ Commit y push cambios
        if: steps.verify-changes.outputs.has_changes == 'true'
        run: |
          # A√±adir todos los cambios en captures (nuevos archivos y eliminaciones)
          git add captures/
          
          # Crear commit con timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_MSG="üì∏ Captura autom√°tica del radar - $TIMESTAMP"
          
          # A√±adir informaci√≥n adicional al commit
          FINAL_COUNT=$(find captures -name "radar_*.png" | wc -l)
          COMMIT_MSG="$COMMIT_MSG (Total: $FINAL_COUNT capturas)"
          
          git commit -m "$COMMIT_MSG"
          
          echo "üöÄ Haciendo push de los cambios..."
          git push

      # 10. Limpiar archivos antiguos (manual adicional si se solicita)
      - name: üßπ Limpieza manual adicional
        if: github.event.inputs.cleanup_old_files == 'true' && github.event_name == 'workflow_dispatch'
        run: |
          echo "üßπ Iniciando limpieza de archivos antiguos..."
          
          # Mantener solo los √∫ltimos 100 archivos
          cd captures
          FILE_COUNT=$(find . -name "radar_*.png" | wc -l)
          
          if [ "$FILE_COUNT" -gt 100 ]; then
            echo "Archivos encontrados: $FILE_COUNT"
            echo "Eliminando archivos antiguos (manteniendo √∫ltimos 100)..."
            
            # Listar archivos por fecha y eliminar los m√°s antiguos
            find . -name "radar_*.png" -printf '%T@ %p\n' | sort -n | head -n -100 | cut -d' ' -f2- | xargs rm -f
            
            NEW_COUNT=$(find . -name "radar_*.png" | wc -l)
            echo "‚úÖ Limpieza completada. Archivos restantes: $NEW_COUNT"
            
            # Commit de la limpieza
            cd ..
            if ! git diff --quiet captures/; then
              git add captures/
              git commit -m "üßπ Limpieza autom√°tica - Mantenidos √∫ltimos 100 archivos"
              git push
            fi
          else
            echo "No es necesario limpiar (solo $FILE_COUNT archivos)"
          fi

      # 11. Resumen de ejecuci√≥n
      - name: üìã Resumen de ejecuci√≥n
        if: always()
        run: |
          echo "=== üìã RESUMEN DE EJECUCI√ìN ==="
          echo "‚è∞ Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "üîÑ Trigger: ${{ github.event_name }}"
          
          if [ "${{ steps.verify-changes.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ Estado: Captura exitosa y cambios commiteados"
            echo "üìä Total de capturas: ${{ steps.verify-changes.outputs.file_count }}"
          else
            echo "‚ÑπÔ∏è  Estado: Ejecuci√≥n completada, sin cambios"
          fi
          
          echo "üìÅ Contenido actual de captures/:"
          ls -la captures/ | tail -5 || echo "No hay archivos en captures/"
          
          echo "üíæ Tama√±o total de la carpeta captures:"
          du -sh captures/ || echo "0B"